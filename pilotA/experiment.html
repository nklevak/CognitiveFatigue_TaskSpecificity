<!DOCTYPE html>
<html>
<head>
  <title>Game Switching</title>

  <!-- Load libraries -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>

  <!-- Initialize jsPsych -->
  <script src="./js/init-jspsych.js"></script>

  <!-- Load jsPsych plug-ins -->
  <script src="./js/plugin-spatial-recall.js"></script>
  <script src="./js/plugin-screen-check.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-animation@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>


  <!-- Load experiment -->
  <script src="./js/spatial-recall.js" type="text/javascript"></script>
  <script src="./js/gradcpt.js"></script>
  <script src="./js/instructions.js"></script>

  <!-- Load CSS styles -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />

</head>
<body></body>
<script>

// INITIALIZE TIMELINE
var timeline = [];

// PRELOADS
timeline.push(preload_auto, preload_manual)

// INTRUCTIONS AND PRACTICE SESSION (edit to include feedback for the trials)
//timeline.push(welcome_practice_instructions,sr_task_instructions,sr_recall_forwards_practice,cpt_task_instructions,gradcpt_practice_trials)

// MAIN EXPERIMENT INSTRUCTIONS
timeline.push(main_exp_BDM_instructions, BDM_quiz, final_exp_instructions)

// MAIN EXPERIMENT
var generated_value = Math.floor(Math.random() * 101);
var currentTask = "spatial_recall" //(50% chance of either task being the first block) // other option is "gradcpt"
if (Math.random() < 0.5) {
    currentTask = "gradcpt"
}
var curr_block = 1

// SWITCH OFFER
var switch_offer_screen = {
    type: jsPsychHtmlSliderResponse,
    stimulus: `<div style="width:500px;">
        <p>How many points do you want to trade to switch games?</p>
        </div>`,
    require_movement: true,
    labels: ['0 points', '50 points', '100 points'],
    on_start: function(switch_offer_screen) {
        generated_value =  Math.floor(Math.random() * 101);
    },
    on_finish: function(data){
        trade_value = jsPsych.data.get().last(1).values()[0].response
        data.generated_BDM_value = generated_value
        data.blocks_completed = curr_block
        
        // if curr_block is not < num_blocks, that means don't add another block and just end the experiment
        if (trade_value >= generated_value && curr_block < num_blocks) {
            console.log("switch tasks")

            if (currentTask == "spatial_recall") {
                currentTask == "gradcpt"

                // switch to gradcpt
                var gradcpt_block_trials = {
                    timeline: getTrials_gradcpt(gradcpt_trials_per_block)
                }
                timeline.push(gradcpt_block_trials)
            } else {
                currentTask == "spatial_recall"

                // switch to spatial_recall
                var sr_list = sr_getBlock()
                console.log(sr_list)
                var sr_block_trials = {
                    timeline: sr_list
                }
                timeline.push(sr_block_trials)
            }

            // incremenet block
            curr_block = curr_block + 1;
            if (curr_block < num_blocks){
                timeline.push(switch_offer_screen)
            } else {// if this will be the last round
                // CONCLUSION OF EXPERIMENT
                timeline.push(switch_offer_screen)
                timeline.push(overall_debrief)
            }

        } else if (curr_block < num_blocks){
            console.log("stay task")
            
            if (currentTask == "spatial_recall") {
                // stay on spatial recall
                var sr_list = sr_getBlock()
                console.log(sr_list)
                var sr_block_trials = {
                    timeline: sr_list
                }
                timeline.push(sr_block_trials)
            } else {
                // stay on gradcpt
                var gradcpt_block_trials = {
                    timeline: getTrials_gradcpt(gradcpt_trials_per_block)
                }
                timeline.push(gradcpt_block_trials)
            }

            // incremenet block
            curr_block = curr_block + 1;

            if (curr_block < num_blocks){
                timeline.push(switch_offer_screen)
            } else {// if this will be the last round
                timeline.push(switch_offer_screen)
                // CONCLUSION OF EXPERIMENT
                timeline.push(overall_debrief)
            }
        }
    }
};

// add the first block:
if (currentTask == "gradcpt"){
    var gradcpt_block_trials = {
        timeline: getTrials_gradcpt(gradcpt_trials_per_block)
    }
    timeline.push(gradcpt_block_trials)

    if (curr_block < num_blocks){
        timeline.push(switch_offer_screen)
    } else {// if this will be the last round
        timeline.push(switch_offer_screen)
        // CONCLUSION OF EXPERIMENT
        timeline.push(overall_debrief)
    }
} else {
    var sr_list = sr_getBlock()
    console.log(sr_list)
    var sr_block_trials = {
        timeline: sr_list
    }
    timeline.push(sr_block_trials)

    if (curr_block < num_blocks){
        timeline.push(switch_offer_screen)
    } else {// if this will be the last round
        timeline.push(switch_offer_screen)
        // CONCLUSION OF EXPERIMENT
        timeline.push(overall_debrief)
    }
}

// RUN THE EXPERIMENT
jsPsych.run(timeline);

</script>
</html>
<!DOCTYPE html>
<html>
<head>
  <title>Game Switching</title>

  <!-- Load libraries -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>

  <!-- Initialize jsPsych -->
  <script src="./js/init-jspsych.js"></script>

  <!-- Load jsPsych plug-ins -->
  <script src="./js/plugin-spatial-recall.js"></script>
  <script src="./js/plugin-screen-check.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-animation@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>


  <!-- Load experiment -->
  <script src="./js/spatial-recall.js" type="text/javascript"></script>
  <script src="./js/gradcpt.js"></script>
  <script src="./js/instructions.js"></script>

  <!-- Load CSS styles -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />

</head>
<body></body>
<script>

// INITIALIZE TIMELINE
var timeline = [];

// PRELOADS
timeline.push(preload_auto, preload_manual)

// INTRUCTIONS AND PRACTICE SESSION (edit to include feedback for the trials)
timeline.push(welcome_practice_instructions,sr_task_instructions,sr_recall_forwards_practice,cpt_task_instructions,gradcpt_practice_trials)

// MAIN EXPERIMENT INSTRUCTIONS
//timeline.push(main_exp_BDM_instructions, BDM_quiz, final_exp_instructions)
timeline.push(final_exp_instructions)

///////////////////////////////////////////////////////////
// MAIN EXPERIMENT
var generated_value = Math.floor(Math.random() * 101);
var currentTask = "spatial_recall" //(50% chance of either task being the first block) // other option is "gradcpt"
if (Math.random() < 0.5) {
    currentTask = "gradcpt"
}
var curr_block = 0
var nextSwitch = false // update this in the on_finish of the switch_offer_screen

// SWITCH OFFER SCREEN
var switch_offer_screen = {
    type: jsPsychHtmlSliderResponse,
    stimulus: `<div style="width:500px;">
        <p>How many points do you want to trade to switch games?</p>
        </div>`,
    require_movement: true,
    labels: ['0 points', '50 points', '100 points'],
    on_start: function(switch_offer_screen) {
        generated_value =  Math.floor(Math.random() * 101);
    },
    on_finish: function(data){
        var trade_value = jsPsych.data.get().last(1).values()[0].response
        data.generated_BDM_value = generated_value
        data.blocks_completed = curr_block
        data.prevBlockType = currentTask

        if (trade_value >= generated_value) {
            nextSwitch = true

            if (currentTask == "spatial_recall") {
                currentTask = "gradcpt"
            } else if (currentTask == "gradcpt") {
                currentTask = "spatial_recall"
            }
        } else {
            nextSwitch = false
        }

        data.switch_next_block = nextSwitch
    }
}

// task switch  or stay trials
var switchingGamesNotification = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: 'You will now switch to a new game',
    choices: 'NO_KEYS',  // No responses allowed
    trial_duration: 1000,
    on_start: function(switchingGamesNotification) {
        if (curr_block >= num_blocks){
            switchingGamesNotification.stimulus = "Great work! We will now debrief you."
        } else if (nextSwitch == false) {
            console.log("stay in same game")
            switchingGamesNotification.stimulus = "You will now stay in the same game"
        }
    }
};

var gradcpt_block_trials = {
    timeline: getTrials_gradcpt(gradcpt_trials_per_block)
}

var sr_block_trials = {
    timeline: sr_getBlock()
}

var full_gradcpt_block = {
    timeline: [gradcpt_block_trials]
}
var full_sr_block = {
    timeline: [sr_block_trials]
}

// FIRST BLOCK ADD MANUALLY
if (curr_block == 0 && currentTask == "spatial_recall") {
    timeline.push(full_sr_block,switch_offer_screen,switchingGamesNotification)
    curr_block = curr_block + 1
} else {
    timeline.push(full_gradcpt_block,switch_offer_screen,switchingGamesNotification)
    curr_block = curr_block + 1
}

// IF NODES FOR REST OF THE BLOCKS
var if_cpt_node = {
    timeline: [full_gradcpt_block],
    conditional_function: function(){// if return true, this timeline gets run if not it gets skipped
        // currentTask will get updated in the switch_offer_screen on finish, so don't need to worry about switch or no switch here
        if (curr_block == num_blocks || currentTask == "spatial_recall"){
            return false
        } else {
            curr_block = curr_block + 1
            return true
        } 
    }
}
var if_sr_node = {
    timeline: [full_sr_block],
    conditional_function: function(){// if return true, this timeline gets run if not it gets skipped
        // currentTask will get updated in the switch_offer_screen on finish, so don't need to worry about switch or no switch here
        if (curr_block == num_blocks || currentTask == "gradcpt"){
            return false
        } else {
            curr_block = curr_block + 1
            return true
        }
    }
}
var if_debrief_node = {
    timeline: [overall_debrief],
    conditional_function: function() {
        if (curr_block == num_blocks){
            return true
        } else {
            return false
        }
    }
}

// add the main experiment
var main_loop = {
    timeline: [if_cpt_node,if_sr_node,switch_offer_screen,switchingGamesNotification,if_debrief_node],
    loop_function: function(data){
        if (curr_block >= num_blocks) {
            return false
        } else {
            return true
        }
    }
}
timeline.push(main_loop)

// RUN THE EXPERIMENT
jsPsych.run(timeline);

</script>
</html>